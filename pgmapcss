#!/usr/bin/env python3
import sys
import re
import pprint
from parser.parse_file import *
from parser.ParseError import *
from compiler.compile_style import *
from mapnik.process_mapnik import *
import argparse
import getpass
import db
import os

parser = argparse.ArgumentParser(description='Compiles a MapCSS style description into PostgreSQL functions and builds an accompanying Mapnik stylesheet.')

parser.add_argument('style_id', type=str, help='''\
  style_id is a required argument. The compiled functions will be prefixed
  by 'style_id', e.g. 'style_id_match()'. Also the resulting mapnik style file
  will be called style_id.mapnik.
''')

parser.add_argument('-d', '--database', dest='database',
    default=getpass.getuser(),
    help='Name of database (default: username)')

parser.add_argument('-u', '--user', dest='user',
    default=getpass.getuser(),
    help='User for database (default: username)')

parser.add_argument('-p', '--password', dest='password',
    default='PASSWORD',
    help='Password for database (default: PASSWORD)')

parser.add_argument('-H', '--host', dest='host',
    default='localhost',
    help='Host for database (default: localhost)')

parser.add_argument('-t', '--template', dest='base_style',
    required=True,
    help='mapcss/mapnik base style for the correct mapnik version, e.g. "mapnik-2.0"')

def init_db(db):
    db.execute(open('src/pgmapcss_types.sql').read())

    for f in os.listdir('eval_functions/'):
        db.execute(open('eval_functions/' + f).read())
    db.execute(open('src/pgmapcss_object.sql').read())
    db.execute(open('src/pgmapcss_render_context.sql').read())
    db.execute(open('src/objects_osm2pgsql.sql').read())
    db.execute(open('src/array_search.sql').read())
    db.execute(open('src/natcasesort.sql').read())
    db.execute(open('src/pgmapcss_to.sql').read())

def install(style_id, style, db):
    db.execute(style['function_check'])
    db.execute(style['function_get_where'])
    db.execute(style['function_match'])

if __name__ == '__main__':
    args = parser.parse_args()

    style_id = args.style_id
    file_name = style_id + '.mapcss'

    db = db.connect(args)

    init_db(db)

    stat = {}

    base_style = 'mapnik/' + args.base_style + '.mapcss'
    try:
        parse_file(stat, file=file_name, base_style=base_style)
    except ParseError as e:
        print(e)
        sys.exit(1)

    pp = pprint.PrettyPrinter()
    pp.pprint(stat)

    style = compile_style(style_id, stat)

    #pp.pprint(style)
    for i in style:
        print("***** " + i + " *****\n" + style[i])

    install(style_id, style, db)
    process_mapnik(style_id, args, stat, db)
